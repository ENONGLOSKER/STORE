{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOKO KAIN</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Favicons -->
    <link href="{%static 'img/logo.svg'%}" rel="icon">
    <link rel="stylesheet" href="{%static 'css/main.css'%}">

</head>
<body>
    <!-- Modal -->
    <dialog id="dialog">
        <h2>Produk</h2>
        <form id="produk-form" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="file" name="img_produk" placeholder="Gambar Produk">
            <input type="text" name="nama_produk" placeholder="Nama Produk">
            <input type="text" name="rettings" placeholder="rettings">
            <input type="text" name="harga" placeholder="Harga">
            <input type="text" name="kategori" placeholder="Kategori">
            <button type="button" id="submit-btn">Submit</button>
        </form>
        <button onclick="window.dialog.close();" aria-label="close" class="x">‚ùå</button>
    </dialog>

    <!-- signin.html -->
    <dialog id="dialogsignin">
        <h2>Sign in</h2>
        <form id="signin-form" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="text" name="username" placeholder="Username">
            <input type="password" name="password" placeholder="Password">
            <button type="button" id="submitSignin">Submit</button>
        </form>
        <button onclick="window.dialogsignin.close();" aria-label="close" class="x">‚ùå</button>
    </dialog>
   
    <!-- signup.html -->
    <dialog id="dialogsignup">
        <h2>Sign up</h2>
        <form id="signup-form" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="text" name="username" placeholder="Username">
            <input type="text" name="email" placeholder="Email">
            <input type="text" name="nomor" placeholder="Nomor">
            <textarea type="text" name="alamat" placeholder="Alamat Lengkap : Kab, Daerah, Kecamatan, Dusun - Desa "></textarea>
            <input type="password" name="password1" placeholder="Password">
            <input type="password" name="password2" placeholder="Confirm Password">
            <button type="button" data-dialog-id="dialogsignup" id="submit-signup-btn">Submit</button>
        </form>
        <button onclick="window.dialogsignup.close();" aria-label="close" class="x">‚ùå</button>
    </dialog>
    <!-- navbar -->
    <nav>
        <div class="logo">
            <img src="{% static 'img/logo.svg' %}" alt="">
             <h3><a href="{% url 'index' %}" style="text-decoration: none; color: var(--dua)">TOKO KAIN</a></h3>
        </div>
        <div class="btncart">
            <a href="{% url 'checkout' %}">
                <p id="jlh">{{ total_items }}</p>
                <ion-icon name="cart" id="cartProduk"></ion-icon>
            </a>
            <a href="{% url 'status' %}">
                <p id="statuspes">Status</p>
            </a>
            <button class="signin" id="signout-btn">Sign out</button>
            <button class="signin" onclick="window.dialogsignin.showModal();">Sign in</button>
            <button class="signup" onclick="window.dialogsignup.showModal();">Sign up</button>
        </div>
    </nav>
    <!-- content -->
    <div class="container">
        <div class="content1">
            <div class="title">
                <h3>Store</h3>
                <p>Hello üëã {{user}}</p>
            </div>
            <!-- index.html -->
            <form method="GET" action="{% url 'index' %}">
                <select name="filter_type" id="filter-type">
                    <option value="">Filter by harga</option>
                    <option value="termurah" {% if filter_type == 'termurah' %}selected{% endif %}>Harga Termurah</option>
                    <option value="termahal" {% if filter_type == 'termahal' %}selected{% endif %}>Harga Termahal</option>
                </select>
                <button type="submit">Filter</button>
            </form>
            
        </div>

        <div class="content2">
            {% for data in produk %}
                <div class="card">
                    <img src="{{data.img_produk.url}}" alt="">
                    <div class="ket">
                        <h3>{{data.nama_produk}}</h3>
                        
                        <div id="reting">
                            <div class="stok">
                                <p>Stok : {{data.stok}}</p>
                            </div>
                            <ion-icon name="star"></ion-icon> 
                            {{data.rettings}}
                        </div>
        
                        <p>Rp. {{data.harga}}</p>
                        <a href="#" class="beli-btn" data-produk-id="{{data.id}}">
                            <ion-icon name="bag-check" id="beli"></ion-icon>
                        </a>
                    </div>
                </div>
            {% endfor %}
        </div>
        
    </div>

    <!-- ionic icon -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <!-- jquery -->
    <script src="{% static 'js/jquery.js' %}"></script>

    <!-- sign out -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var signoutButton = document.getElementById("signout-btn");

            signoutButton.addEventListener("click", function () {
                signout();
            });
        });

        function signout() {
            $.ajax({
                type: "POST",
                url: "{% url 'signout' %}",  // Ganti 'signout' dengan nama URL view sign-out
                data: {csrfmiddlewaretoken: "{{ csrf_token }}",},
                success: function (data) {
                    if (data.success) {
                        alert("Logout berhasil");
                        window.location.href = "{% url 'index' %}";  // Redirect ke halaman utama atau halaman login
                    } else {
                        alert("Logout gagal: " + data.message);
                    }
                },
                error: function () {
                    alert("Terjadi kesalahan saat mengirim permintaan sign-out.");
                }
            });
        }
    </script>

    <!-- sign in-->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var signinButton = document.getElementById("submitSignin");
    
            signinButton.addEventListener("click", function () {
                submitSigninForm();
            });
        });
    
        function submitSigninForm() {
            var form = document.getElementById("signin-form");
    
            $.ajax({
                type: "POST",
                url: "{% url 'signin' %}",
                data: $(form).serialize(),
                success: function (data) {
                    if (data.success) {
                        alert("Login berhasil");
                        window.location.href = "{% url 'index' %}";
                    } else {
                        alert("Login gagal: " + data.message);
                    }
                },
                error: function () {
                    alert("Terjadi kesalahan saat mengirim formulir.");
                }
            });
        }
    </script>

    <!-- sign up -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var signupButton = document.getElementById("submit-signup-btn");

            signupButton.addEventListener("click", function () {
                submitForm('signup-form');
            });
        });

        function submitForm(formId) {
            var form = document.getElementById(formId);
            var dialogId = form.getAttribute("data-dialog-id");

            $.ajax({
                type: "POST",
                url: "{% url 'signup' %}",
                data: $(form).serialize(),
                success: function (data) {
                    if (data.success) {
                        alert(data.message);
                        window.location.href = "{% url 'index' %}";
                    } else {
                        alert("Gagal: " + data.errors);
                    }
                },
                error: function (jqXHR) {
                    // Tangkap respon kesalahan dan tampilkan pesan kesalahan yang lebih informatif
                    var errorMessage = "Terjadi kesalahan saat mengirim formulir.";
                    if (jqXHR.responseJSON && jqXHR.responseJSON.errors) {
                        errorMessage = "Gagal: " + jqXHR.responseJSON.errors;
                    }
                    alert(errorMessage);
                }
            });
        }
    </script>

    <!-- cart -->
    <script>
        $(document).ready(function () {
            $('.beli-btn').click(function (e) {
                e.preventDefault();
                var produkId = $(this).data('produk-id');
                addToCart(produkId);
            });
    
            function addToCart(produkId) {
                $.ajax({
                    type: 'POST',
                    url: `/add_to_cart/${produkId}/`,  // Sesuaikan dengan URL Anda
                    data: {
                        csrfmiddlewaretoken: "{{ csrf_token }}",
                    },
                    success: function (data) {
                        if (data.success) {
                            alert("Item berhasil ditambahkan ke keranjang");
                            updateCartCount();
                        } else {
                            alert("Gagal menambahkan item ke keranjang: " + data.message);
                        }
                    },
                    error: function () {
                        alert("Terjadi kesalahan saat mengirim formulir.");
                    }
                });
            }
    
        updateCartCount();  // Panggil fungsi ini saat halaman dimuat

        function updateCartCount() {
            $.ajax({
                type: 'GET',
                url: '/cart_item_count/',  // Sesuaikan dengan URL Anda
                success: function (data) {
                    $('#jlh').text(data.cart_count);
                },
                error: function () {
                    // alert("Terjadi kesalahan saat memperbarui jumlah item keranjang.");
                }
            });
        }
        });
    </script>
    
    
</body>
</html>